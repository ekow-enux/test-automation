# EC2 Server Setup and Configuration Guide

This guide covers the complete setup and configuration required for your EC2 Ubuntu server to support the Node.js backend deployment pipeline.

## Prerequisites

### EC2 Instance Requirements
- **OS**: Ubuntu (20.04 LTS or newer recommended)
- **Instance Type**: t3.small or larger (minimum 1GB RAM, 1 vCPU)
- **Storage**: 20GB+ SSD
- **Security Group**: Allow inbound traffic on ports 22 (SSH), 80 (HTTP), 443 (HTTPS), 4000 (App)

### Domain Configuration
- **Domain**: server.ekowlabs.space
- **DNS**: Point to your EC2 instance's public IP address

## Initial Server Setup

### 1. Connect to EC2 Instance
```bash
ssh -i your-key.pem ubuntu@your-ec2-ip
```

### 2. Update System Packages
```bash
sudo apt update && sudo apt upgrade -y
sudo reboot  # Recommended after major updates
```

### 3. Install Required Software
```bash
# Install Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install PM2 globally
sudo npm install -g pm2

# Install other required tools
sudo apt install -y unzip curl nginx git

# Verify installations
node --version    # Should show v20.x.x
npm --version
pm2 --version
unzip --version
```

### 4. Configure Firewall (UFW)
```bash
# Enable UFW
sudo ufw enable

# Allow SSH, HTTP, HTTPS, and application port
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 4000/tcp

# Check status
sudo ufw status
```

### 5. Create Deployment Directory
```bash
# Create application directory
sudo mkdir -p /var/www/app
sudo chown ubuntu:ubuntu /var/www/app
sudo chmod 755 /var/www/app

# Create logs directory
sudo mkdir -p /var/log/app
sudo chown ubuntu:ubuntu /var/log/app
sudo chmod 755 /var/log/app
```

## User and Permissions Setup

### 1. Create Application User (Optional but Recommended)
```bash
# Create dedicated user for application
sudo useradd -r -s /bin/bash -d /var/www/app -m appuser

# Add user to sudo group
sudo usermod -aG sudo appuser

# Switch to app user
sudo su - appuser
```

### 2. SSH Key Setup (CRITICAL - Do NOT Modify ~/.ssh/authorized_keys)

**IMPORTANT**: The deployment process explicitly avoids modifying `~/.ssh/authorized_keys` to prevent SSH key conflicts.

```bash
# DO NOT modify ~/.ssh/authorized_keys
# The deployment uses SSH agent forwarding from GitHub Actions

# Verify your SSH keys are working
ssh -T git@github.com  # Should show GitHub authentication message
```

### 3. Set Proper File Permissions
```bash
# Set ownership for application directory
sudo chown -R ubuntu:ubuntu /var/www/app
sudo chown -R ubuntu:ubuntu /var/log/app

# Set appropriate permissions
sudo chmod 755 /var/www/app
sudo chmod 644 /var/www/app/* 2>/dev/null || true

# Ensure PM2 can manage processes
sudo pm2 startup
# Follow the instructions provided by PM2
```

## PM2 Configuration

### 1. Configure PM2 Startup
```bash
# Set PM2 to start on system boot
sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu

# Save current PM2 processes
pm2 save
```

### 2. Create PM2 Ecosystem File (Optional)
```bash
# Create ecosystem.config.js in /var/www/app when needed
cat > /var/www/app/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'node-app',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development',
      PORT: 4000
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 4000
    },
    log_file: '/var/log/app/node-app.log',
    error_file: '/var/log/app/node-app-error.log',
    out_file: '/var/log/app/node-app-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    max_memory_restart: '1G'
  }]
};
EOF
```

## Nginx Configuration (Optional but Recommended)

### 1. Install and Configure Nginx
```bash
sudo apt install -y nginx
```

### 2. Create Nginx Site Configuration
```bash
sudo tee /etc/nginx/sites-available/server.ekowlabs.space << 'EOF'
server {
    listen 80;
    server_name server.ekowlabs.space;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name server.ekowlabs.space;
    
    # SSL Configuration (add your certificates)
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Proxy to Node.js application
    location / {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # Health check endpoint
    location /api/health {
        proxy_pass http://localhost:4000/api/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

# Enable the site
sudo ln -s /etc/nginx/sites-available/server.ekowlabs.space /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Restart Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

## Environment Variables Setup

### 1. Create Application Environment File
```bash
# Create .env file in deployment directory
cat > /var/www/app/.env << 'EOF'
NODE_ENV=production
PORT=4000
# Add your other environment variables here
EOF

# Set proper permissions
chmod 600 /var/www/app/.env
chown ubuntu:ubuntu /var/www/app/.env
```

## Monitoring and Logging

### 1. Setup Log Rotation
```bash
# Create logrotate configuration
sudo tee /etc/logrotate.d/node-app << 'EOF'
/var/log/app/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 644 ubuntu ubuntu
    postrotate
        pm2 reload node-app > /dev/null 2>&1 || true
    endscript
}
EOF
```

### 2. Monitor System Resources
```bash
# Install monitoring tools
sudo apt install -y htop iotop

# Check system resources
htop
df -h
free -h
```

## Deployment Script Setup

### 1. Upload deploy.sh Script
```bash
# Upload the deploy.sh script to the server
scp deploy.sh ubuntu@your-ec2-ip:/home/ubuntu/

# Make it executable
chmod +x deploy.sh

# Move to a global location (optional)
sudo mv deploy.sh /usr/local/bin/deploy-app
sudo chown ubuntu:ubuntu /usr/local/bin/deploy-app
sudo chmod +x /usr/local/bin/deploy-app
```

## GitHub Actions Secrets Configuration

Add these secrets to your GitHub repository:

### Required Secrets:
- **SSH_KEY**: Your private SSH key for the EC2 instance
- **SSH_USER**: The username for SSH connection (usually 'ubuntu')
- **SSH_HOST**: The public IP address or domain of your EC2 instance

### Optional Secrets:
- **ENV_NODE_ENV**: production
- **ENV_PORT**: 4000

## Testing the Setup

### 1. Test Manual Deployment
```bash
# Test the deployment script manually
./deploy.sh --zip-file /tmp/your-deployment.zip --verbose
```

### 2. Test PM2 Management
```bash
# Check PM2 status
pm2 status

# View logs
pm2 logs node-app

# Restart application
pm2 restart node-app
```

### 3. Test Health Endpoint
```bash
# Test internal health check
curl http://localhost:4000/api/health

# Test external health check (if domain is configured)
curl https://server.ekowlabs.space/api/health
```

## Troubleshooting

### Common Issues and Solutions

1. **Permission Denied Errors**
   ```bash
   sudo chown -R ubuntu:ubuntu /var/www/app
   sudo chmod -R 755 /var/www/app
   ```

2. **PM2 Not Starting on Boot**
   ```bash
   sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
   pm2 save
   ```

3. **Port Already in Use**
   ```bash
   sudo lsof -i :4000
   pm2 stop node-app
   pm2 delete node-app
   ```

4. **Nginx Configuration Issues**
   ```bash
   sudo nginx -t  # Test configuration
   sudo systemctl status nginx
   sudo journalctl -u nginx -f
   ```

### Log Locations
- Application logs: `/var/log/app/`
- PM2 logs: `pm2 logs node-app`
- Nginx logs: `/var/log/nginx/`
- System logs: `sudo journalctl -f`

## Security Best Practices

1. **Keep System Updated**: Regularly update packages
   ```bash
   sudo apt update && sudo apt upgrade
   ```

2. **Use Strong SSH Keys**: Ensure SSH keys are properly secured
   ```bash
   chmod 600 ~/.ssh/id_rsa
   chmod 644 ~/.ssh/id_rsa.pub
   ```

3. **Monitor Access Logs**: Regularly check authentication logs
   ```bash
   sudo tail -f /var/log/auth.log
   ```

4. **Backup Important Data**: Regularly backup application data
   ```bash
   # Create backup script
   sudo tar -czf /backup/app-backup-$(date +%Y%m%d).tar.gz /var/www/app
   ```

5. **Firewall Configuration**: Keep UFW rules minimal and updated
   ```bash
   sudo ufw status verbose
   ```

## Next Steps

After completing this setup:

1. **Test the complete deployment pipeline** by pushing to your main branch
2. **Monitor initial deployments** to ensure everything works correctly
3. **Set up monitoring alerts** for application health and system resources
4. **Configure backup procedures** for important application data
5. **Document any custom configurations** specific to your application