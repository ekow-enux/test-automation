on:
  push:
    branches:
      - main
      

jobs:
  deploy:
    name: Deploy to Production Server
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: api-artifact
          path: ./api

      - name: Verify artifact contents
        run: |
          echo "=== Artifact content ==="
          ls -la ./api
          if [ ! -f ./api/package.json ]; then
            echo "‚ùå ERROR: package.json is missing from artifact"
            exit 1
          fi

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Ensure /var/www/api exists and permissions are correct
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            sudo mkdir -p /var/www/api
            sudo chown -R $USER:$USER /var/www/api
            sudo chmod -R 775 /var/www/api
          EOF

      - name: Upload files to /var/www/api via rsync
        run: |
          echo "Deploying to /var/www/api"
          rsync -avz --rsync-path="sudo rsync" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./api/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/api

      - name: Run deployment commands on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /var/www/api || exit 1

            echo "=== Writing .env file ==="
            cat > .env << 'EOL'
            NODE_ENV=${{ secrets.ENV_NODE_ENV }}
            PORT=${{ secrets.ENV_PORT }}
            EOL

            echo "=== Installing production dependencies ==="
            npm install --omit=dev

            echo "=== Setting up PM2 ==="
            npm install -g pm2
            pm2 startOrRestart ecosystem.config.js --env production || pm2 start server.js
            pm2 save

            echo "=== Reloading NGINX ==="
            sudo systemctl reload nginx || true

            echo "=== Health check ==="
            curl -f http://localhost:${{ secrets.ENV_PORT }}/api/health || echo "‚ö† API not responding yet"

            echo "üéâ Deployment to /var/www/api complete!"
          EOF
