name: CI/CD - API Unit Test | E2E Test | Build | Artifact | Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: 20
  APP_PORT: 4000
  API_DIR: api

jobs:
  unit-test:
    name: Unit Tests â€” Jest
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.API_DIR }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.API_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Jest Unit Tests
        run: npm run test

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: ${{ env.API_DIR }}/coverage/
          retention-days: 7

  e2e-test:
    name: E2E Tests â€” Cypress
    runs-on: ubuntu-latest
    needs: unit-test
    # Removed default working-directory since we explicitly cd into api in our steps
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.API_DIR }}/package-lock.json

      - name: Install dependencies
        run: |
          cd api
          npm ci

      - name: Start API server
        run: |
          cd api
          npm run start &
          sleep 5

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:${{ env.APP_PORT }}/api/health >/dev/null 2>&1; then
              echo "API is ready!"
              break
            fi
            echo "Waiting for API... attempt $i/30"
            sleep 2
          done

      - name: Run Cypress E2E Tests (headless)
        run: |
          cd api
          npx cypress run --config-file cypress.config.js --browser chrome --headless
        env:
          NODE_ENV: production
          PORT: ${{ env.APP_PORT }}

  build-artifact:
    name: Build & Create Deployment Artifact
    runs-on: ubuntu-latest
    needs: e2e-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.API_DIR }}/package-lock.json

      - name: Install dependencies
        run: |
          cd ${{ env.API_DIR }}
          npm ci

      - name: Create deployment artifact
        run: |
          cd ${{ env.API_DIR }}
          echo "=== Creating deployment zip artifact ==="
          zip -r app.zip . \
            -x "node_modules/*" \
            -x "coverage/*" \
            -x "cypress/videos/*" \
            -x "cypress/screenshots/*" \
            -x ".env*" \
            -x "*.log"
          echo "=== Artifact created ==="
          ls -la app.zip
          echo "=== Verifying deploy.sh is included ==="
          unzip -l app.zip | grep deploy.sh || echo "Warning: deploy.sh not found in artifact"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-deployment-artifact
          path: ${{ env.API_DIR }}/app.zip
          retention-days: 7

  deploy:
    name: Deploy to Production Server
    needs: build-artifact
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: api-deployment-artifact
          path: ./

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Verify artifact
        run: |
          echo "=== Verifying deployment artifact ==="
          ls -la app.zip
          echo "=== Artifact size ==="
          du -h app.zip

      - name: Copy artifact to server via SCP
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DEPLOY_PATH: ${{ secrets.SERVER_PATH || '/var/www/api' }}
        run: |
          echo "=== Copying artifact to server via SCP ==="
          
          # Create deployment directory if it doesn't exist
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "sudo mkdir -p $DEPLOY_PATH && sudo chown $USER:$USER $DEPLOY_PATH"
          
          # Copy the zip artifact to server
          scp -o StrictHostKeyChecking=no app.zip $SSH_USER@$SSH_HOST:$DEPLOY_PATH/
          
          echo "âœ… Artifact copied successfully"

      - name: Execute deployment script on server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DEPLOY_PATH: ${{ secrets.SERVER_PATH || '/var/www/api' }}
          NODE_ENV: ${{ secrets.ENV_NODE_ENV }}
          PORT: ${{ secrets.ENV_PORT }}
        run: |
          echo "=== Executing deployment on server ==="
          
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            set -e
            
            echo "=== Starting deployment process ==="
            cd "$DEPLOY_PATH"
            
            # Extract the new deployment
            echo "=== Extracting new deployment ==="
            if [ -f "app.zip" ]; then
              # Backup current deployment
              if [ -d "current" ]; then
                rm -rf previous
                mv current previous
              fi
              mkdir -p current
              cd current
              unzip -q ../app.zip
              echo "âœ… New deployment extracted"
            else
              echo "âŒ app.zip not found!"
              exit 1
            fi
            
            # Run the deployment script
            echo "=== Running deployment script ==="
            if [ -f "deploy.sh" ]; then
              chmod +x deploy.sh
              ./deploy.sh
            else
              echo "âŒ deploy.sh not found!"
              exit 1
            fi
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          EOF

      - name: Deployment Status Notification
        run: |
          echo "=== Deployment Status Summary ==="
          echo "âœ… Deployment completed successfully"
          echo "Deployment path: ${{ secrets.SERVER_PATH || '/var/www/api' }}"
          echo "Artifact: app.zip"
          echo "=== Deployment Complete ==="
