name: Backend Deployment - Build, SCP, Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: 20
  BACKEND_DIR: backend
  SERVER_PATH: /var/www/api
  DOMAIN: serve.ekowlabs.space

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ${{ env.BACKEND_DIR }}/coverage/
          retention-days: 7

  build-and-package:
    name: Build & Create Deployment Package
    runs-on: ubuntu-latest
    needs: test-backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: Create deployment directory structure
        run: |
          mkdir -p deployment-package
          cp -r ${{ env.BACKEND_DIR }}/* deployment-package/
          
          # Rename src/server.js to server.js for deployment
          if [ -f "deployment-package/src/server.js" ]; then
            mv deployment-package/src/server.js deployment-package/server.js
            rmdir deployment-package/src 2>/dev/null || true
          fi
          
          # Clean up unnecessary files for deployment
          rm -rf deployment-package/tests
          rm -rf deployment-package/cypress
          rm -f deployment-package/README.md
          rm -f deployment-package/*.config.js
          
          echo "=== Deployment package contents ==="
          ls -la deployment-package/

      - name: Create deployment artifact (.zip)
        run: |
          cd deployment-package
          zip -r ../backend-deployment.zip .
          cd ..
          echo "=== Created deployment artifact ==="
          ls -lh backend-deployment.zip

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-deployment
          path: backend-deployment.zip
          retention-days: 7

  deploy-to-server:
    name: Deploy to Production Server
    needs: build-and-package
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-deployment
          path: ./

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Verify artifact
        run: |
          echo "=== Verifying deployment artifact ==="
          ls -lh backend-deployment.zip
          echo "=== Extracting artifact for verification ==="
          unzip -l backend-deployment.zip | head -20

      - name: Transfer artifact to server using SCP
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SERVER_PATH: ${{ env.SERVER_PATH }}
        run: |
          echo "=== Transferring artifact to server using SCP ==="
          scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            backend-deployment.zip \
            $SSH_USER@$SSH_HOST:/tmp/
          
          echo "‚úÖ Artifact transferred successfully"

      - name: Execute deployment script on server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SERVER_PATH: ${{ env.SERVER_PATH }}
        run: |
          echo "=== Starting deployment on server ==="
          
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "=== Starting deployment process ==="
            echo "Server: $(hostname)"
            echo "User: $(whoami)"
            echo "Current directory: $(pwd)"
            
            # Define deployment paths
            DEPLOY_PATH="$SERVER_PATH"
            TEMP_PATH="/tmp/backend-deployment"
            BACKUP_PATH="${DEPLOY_PATH}.backup.$(date +%Y%m%d_%H%M%S)"
            
            echo "=== Deployment path: $DEPLOY_PATH ==="
            echo "=== Backup path: $BACKUP_PATH ==="
            echo "=== Temp path: $TEMP_PATH ==="
            
            # Extract deployment artifact
            echo "=== Extracting deployment artifact ==="
            mkdir -p "$TEMP_PATH"
            cd "$TEMP_PATH"
            unzip -q /tmp/backend-deployment.zip
            echo "‚úÖ Artifact extracted"
            
            # Verify extracted contents
            echo "=== Verifying extracted contents ==="
            ls -la
            if [ ! -f "server.js" ]; then
              echo "‚ùå ERROR: server.js not found in extracted artifact!"
              exit 1
            fi
            if [ ! -f "package.json" ]; then
              echo "‚ùå ERROR: package.json not found in extracted artifact!"
              exit 1
            fi
            echo "‚úÖ Required files found"
            
            # Create deployment directory if it doesn't exist
            echo "=== Preparing deployment directory ==="
            sudo mkdir -p "$DEPLOY_PATH"
            sudo chown $USER:$USER "$DEPLOY_PATH"
            
            # Backup existing deployment if it exists
            if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
              echo "=== Creating backup of existing deployment ==="
              sudo cp -r "$DEPLOY_PATH" "$BACKUP_PATH"
              echo "‚úÖ Backup created: $BACKUP_PATH"
            fi
            
            # Stop PM2 process if running
            echo "=== Stopping PM2 process ==="
            pm2 stop node-app 2>/dev/null || echo "PM2 process not running or already stopped"
            pm2 delete node-app 2>/dev/null || echo "PM2 process not found or already deleted"
            
            # Clean deployment directory and copy new files
            echo "=== Deploying new version ==="
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo cp -r "$TEMP_PATH"/* "$DEPLOY_PATH/"
            sudo chown -R $USER:$USER "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
            
            # Verify deployment
            echo "=== Verifying deployment ==="
            ls -la
            if [ ! -f "server.js" ]; then
              echo "‚ùå ERROR: server.js not found after deployment!"
              exit 1
            fi
            
            # Install production dependencies
            echo "=== Installing production dependencies ==="
            npm ci --omit=dev
            
            # Start application with PM2
            echo "=== Starting application with PM2 ==="
            pm2 start server.js --name node-app
            pm2 save
            
            # Verify PM2 process
            echo "=== Verifying PM2 process ==="
            pm2 status
            pm2 logs node-app --lines 5
            
            # Clean up
            echo "=== Cleaning up temporary files ==="
            rm -rf "$TEMP_PATH"
            rm -f /tmp/backend-deployment.zip
            
            # Health check
            echo "=== Running health check ==="
            sleep 5
            if curl -f http://localhost:4000/api/health >/dev/null 2>&1; then
              echo "‚úÖ Health check passed"
            else
              echo "‚ö†Ô∏è  Health check failed, but deployment completed"
            fi
            
            echo "üéâ Deployment completed successfully!"
            echo "=== Deployment Summary ==="
            echo "Deployed to: $DEPLOY_PATH"
            echo "Backup location: $BACKUP_PATH"
            echo "Application: node-app (PM2)"
            echo "Domain: $DOMAIN"
          EOF

      - name: Final deployment verification
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DOMAIN: ${{ env.DOMAIN }}
        run: |
          echo "=== Final deployment verification ==="
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'EOF'
            echo "=== PM2 Status ==="
            pm2 status
            
            echo "=== Application Logs (last 10 lines) ==="
            pm2 logs node-app --lines 10 --nostream
            
            echo "=== Server Status ==="
            echo "Server: $(hostname)"
            echo "Uptime: $(uptime)"
            echo "Disk usage:"
            df -h /var/www
            
            echo "=== Network Status ==="
            netstat -tlnp | grep :4000 || echo "Port 4000 not listening"
          EOF
          
          # External health check
          echo "=== External Health Check ==="
          sleep 10
          if curl -f https://$DOMAIN/api/health >/dev/null 2>&1; then
            echo "‚úÖ External health check passed"
          else
            echo "‚ö†Ô∏è  External health check failed - this may be normal if DNS hasn't propagated"
          fi

      - name: Deployment Summary
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "‚úÖ Backend deployment completed successfully!"
          echo "üìÅ Deployment path: ${{ env.SERVER_PATH }}"
          echo "üöÄ PM2 process: node-app"
          echo "üåê Domain: ${{ env.DOMAIN }}"
          echo "üìã Health endpoint: https://${{ env.DOMAIN }}/api/health"
          echo ""
          echo "Next steps:"
          echo "1. Verify application is accessible at https://${{ env.DOMAIN }}"
          echo "2. Check PM2 logs: pm2 logs node-app"
          echo "3. Monitor application: pm2 status"